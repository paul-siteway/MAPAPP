(function(){window.MapApp={Models:{},Collections:{},Views:{}};window.template=function(e){return _.template($("#"+e).html())};MapApp.vents=_.extend({},Backbone.Events);$("select#ellType").change(function(){MapApp.vents.trigger("filterbyType")});$("#searchTitle").on("keyup",function(){query=$(this).val();console.log(query);filteredLocations=MapApp.initialLocationsCollection.query({title:{$likeI:query}});MapApp.locationsCollection.reset(filteredLocations)});$(".reset").on("click",function(e){e.preventDefault();MapApp.resetFilters()});MapApp.filterList=[];MapApp.addLocationToMap=function(e,t,n,r){MapApp.map.addMarker({lat:t,lng:n,title:r,html:"",click:function(e){},infoWindow:{content:$("#locationsView #location"+e).html()}});return"marker added"};MapApp.removeMarkers=function(){MapApp.map.removeMarkers()};MapApp.mapInit=function(){MapApp.map=new GMaps({div:"#map",lat:53.571148,lng:10.024898,zoom:3})};MapApp.mapInit();MapApp.readProp=function(e,t){return e[t]};MapApp.activateMultiselect=function(){$("select.multiselect").val([]);$(".multiselect").multiselect({buttonClass:"btn",buttonWidth:"auto",maxHeight:!1,buttonText:function(e,t){return e.length===0?t.attr("data-name")+'<b class="caret"></b>':e.length>0?t.attr("data-name")+" ("+e.length+') <b class="caret"></b>':t.attr("data-name")+'<b class="caret"></b>'},onChange:function(e,t){filtername=e.parent().attr("data-name");MapApp.vents.trigger("selectChanged",e,filtername,t)}})};MapApp.resetFilters=function(){$("#searchTitle").val("");$("select.multiselect").val([]);$("select.multiselect").multiselect("refresh");MapApp.vents.trigger("selectChanged")};MapApp.Router=Backbone.Router.extend({routes:{"":"index","show/:id":"show",showAll:"showAll","add/:id/*title":"add","search/*title":"search","*other":"Default"},index:function(){},show:function(e){console.log("show:"+e);MapApp.vents.trigger("location:show",e)},showAll:function(e){MapApp.vents.trigger("location:showAll",e)},add:function(e,t){console.log("add id:"+e+" title:"+t)},search:function(e){console.log("search title:"+e)},Default:function(e){console.log("Not sure wht you tying to do: you acessed:"+e)}});MapApp.router=new MapApp.Router;Backbone.history.start();MapApp.Models.Locations=Backbone.DeepModel.extend({defaults:{lat:51.511214,lon:-0.119824,title:"im am the default Title",logo:"http://lorempixel.com/80/80/people/",link:"http://www.google.de"},sync:function(){return!1},validate:function(e){if(!_.isNumber(e.lat))return"lat Must not be empty";if(!_.isNumber(e.lon))return"lon Must not be empty";if(!$.trim(e.title))return"title Must not be empty"},display:function(){return this.get("title")+" is displaying"}});MapApp.Views.Location=Backbone.View.extend({tagName:"div",className:"location",events:{click:"showLocationInMap","click strong":"showAlert","click button":"destroy"},template:template("locationTemplate"),initialize:function(){this.model.on("change",this.render,this);this.model.on("destroy",this.remove,this)},render:function(){var e=this.model.get("id");this.$el.html(this.template(this.model.toJSON())).attr("id","location"+e);MapApp.vents.trigger("locationAdded");return this},showAlert:function(){var e=prompt("edit the Title:",this.model.get("title"));if(!e)return;this.model.set("title",e)},destroy:function(){this.model.destroy()},remove:function(){this.$el.remove()},showLocationInMap:function(){var e=this.model.get("lat"),t=this.model.get("lon");MapApp.map.setCenter(e,t);MapApp.map.setZoom(6)}});MapApp.Views.Locations=Backbone.View.extend({tagName:"div",initialize:function(){this.collection.on("add",this.addOne,this);this.collection.on("reset",this.render,this);MapApp.vents.on("filterbyType",this.startFilterType,this);MapApp.vents.on("startSearch",this.search,this)},render:function(){this.$el.html("");this.collection.each(this.addOne,this);return this},renderFiltered:function(e){$("#locationsView").html("");e.each(function(e){var t=new MapApp.Views.Location({model:e,collection:this.collection});$("#locationsView").append(t.render().el)});return this},addOne:function(e){var t=new MapApp.Views.Location({model:e});this.$el.append(t.render().el)},startFilterType:function(){var e=$("#ellType").find("option:selected").val()}});MapApp.Views.Filter=Backbone.View.extend({tagName:"select",className:"span2 multiselect",template:template("filterTemplate"),initialize:function(){this.$el.attr("data-name",MapApp.filterList[this.options.index])},render:function(){this.renderFilters();this.renderallOptions()},renderFilters:function(){var e=MapApp.filterList[this.options.index]},renderallOptions:function(){var e=MapApp.optionsCollection.at(this.options.index).get("filteroptions");MapApp["filterOptionsArray"+this.options.index]=[];_.each(e,function(e,t){_.each(e,function(e,t){MapApp["filterOptionsArray"+this.options.index].push(e)},this)},this);MapApp["filterOptionsArray"+this.options.index]=_.uniq(MapApp["filterOptionsArray"+this.options.index]);_.each(MapApp["filterOptionsArray"+this.options.index],function(e){this.$el.append(this.template({optionName:e}))},this)}});MapApp.Views.Filters=Backbone.View.extend({tagName:"div",className:"filters",initialize:function(){MapApp.vents.on("selectChanged",this.updateQueryObject,this);this.collection.on("reset",this.update,this);this.create()},create:function(){this.createFilterList();this.createOptionsLists();this.render();MapApp.activateMultiselect()},update:function(){this.createOptionsLists()},createFilterList:function(){MapApp.filterList=[];this.collection.each(function(e){var t=e.get("filterable");for(var n in t)MapApp.filterList.push(n)});MapApp.filterList=_.uniq(MapApp.filterList)},createOptionsLists:function(){MapApp.optionsLists={};MapApp.optionsCollection.reset();_.each(MapApp.filterList,function(e,t){MapApp.optionsCollection.add({});MapApp.optionsCollection.at(t).set("filtername",e);var n=[];MapApp.locationsCollection.each(function(t){var r=t.get("filterable")[e];n.push(r)});MapApp.optionsCollection.at(t).set("filteroptions",n)})},render:function(){this.$el.html("");_.each(MapApp.filterList,function(e,t){MapApp.filterView=new MapApp.Views.Filter({index:t});MapApp.filterView.render();this.$el.append(MapApp.filterView.el)},this);return this},updateQueryObject:function(){MapApp.queryObject={};$("select.multiselect").each(function(){filtername="filterable."+$(this).attr("data-name");selected={$all:$(this).val()};if($(this).val()==null)return;MapApp.queryObject[filtername]=selected});console.log("##################");console.log("THE COLLECTION IS:");console.log(MapApp.locationsCollection);console.log("THE QUERY OBJECT IS: ");console.log(MapApp.queryObject);filteredLocations=MapApp.initialLocationsCollection.query(MapApp.queryObject);console.log("THE RESULT IS: ");console.log(filteredLocations);MapApp.locationsCollection.reset(filteredLocations)}});MapApp.Views.Map=Backbone.View.extend({el:"#mapActions",events:{"click #showAll":"showAll","click #removeAll":"removeAll"},initialize:function(){MapApp.vents.on("location:showAll",this.showAll,this);MapApp.vents.on("locationAdded",this.showAll,this);this.collection.on("add",this.showAll,this);this.collection.on("remove",this.showAll,this);this.collection.on("reset",this.showAll,this);this.showAll()},showAll:function(){console.log("Showing Markers");this.removeAll();this.collection.each(this.addLocation,this);this.collection.length!=0?MapApp.map.fitZoom():MapApp.mapInit()},removeAll:function(){MapApp.removeMarkers()},addLocation:function(e){var t=e.get("lat"),n=e.get("lon"),r=e.get("title"),i=e.get("logo"),s=e.get("id"),o=e.get("nationalCLC"),u=e.get("actionLines"),a=e.get("eLLType"),f=e.get("link");MapApp.addLocationToMap(s,t,n,r)},destroyMarker:function(e){this.model.destroy()},remove:function(){this.$el.remove()}});MapApp.Views.CreateLocation=Backbone.View.extend({el:"#addLocation",events:{submit:"submit"},initialize:function(){},submit:function(e){e.preventDefault();var t=$(e.currentTarget).find("input.title").val(),n=$(e.currentTarget).find("input.lat").val(),r=$(e.currentTarget).find("input.lon").val(),i=new MapApp.Models.Locations;i.set({title:t,lat:n,lon:r});this.collection.add(i)}});MapApp.Collections.Locations=Backbone.QueryCollection.extend({model:MapApp.Models.Locations});MapApp.Models.option=Backbone.Model.extend({defaults:{filtername:"Filtername",filteroptions:"[1,2,3,4]"}});MapApp.Collections.Options=Backbone.QueryCollection.extend({model:MapApp.Models.option});MapApp.optionsCollection=new MapApp.Collections.Options([]);MapApp.locationsCollection=new MapApp.Collections.Locations([{id:0,title:"Experience & Living Lab Berlin",lat:52.519171,lon:13.406091,logo:"http://lorempixel.com/g/80/80/nature/",filterable:{City:["Berlin"],InnovationArea:["Smart Energy Systems"],Services:["Service1","Service2","Service3","Service4"],LocationType:["Office"]},link:"http://www.google.de"},{id:1,title:"Experience & Living Lab Trento",lat:46.069692,lon:11.12108,logo:"http://lorempixel.com/g/80/80/sports/",filterable:{City:["Trento"],InnovationArea:["Networking Solutions for Future Media"],Services:["Service1","Service2","Service3","Service4"],LocationType:["Office","Hackspace"]},link:"http://www.google.de"},{id:2,title:"Experience & Living Lab Helsinki",lat:60.169845,lon:24.938551,logo:"http://lorempixel.com/g/80/80/cats/",filterable:{City:["Helsinki"],InnovationArea:["Computing in the Cloud","Smart Spaces"],Services:["Service1","Service2","Service3","Service4"],LocationType:["University"]},link:"http://www.google.de"},{id:3,title:"Experience & Living Lab Eindhoven",lat:51.441642,lon:5.469723,logo:"http://lorempixel.com/g/80/80/abstract/",filterable:{City:["Eindhoven"],InnovationArea:["Health & Wellbeing","Smart Energy Systems"],Services:["Service1","Service2","Service3","Service4"],LocationType:["Lab"]},link:"http://www.google.de"},{id:4,title:"New Lab Berlin",lat:53.519171,lon:14.406091,logo:"http://lorempixel.com/g/80/80/nature/",deep:{title:["hello"]},filterable:{City:["Berlin","Hamburg"],InnovationArea:["Computing in the Cloud","Smart Energy Systems","Health & Wellbeing"],Services:["Service1","Service2","Service3","All Services"],LocationType:["Office","Lab","Other"]},link:"http://www.google.de"},{id:5,tags:["jquery","html5","backbone"],filterable:{}}]);MapApp.initialLocationsCollection=new MapApp.Collections.Locations(MapApp.locationsCollection.toJSON());MapApp.filterView=new MapApp.Views.Filter({model:MapApp.Models.Locations});MapApp.filtersView=new MapApp.Views.Filters({collection:MapApp.locationsCollection});$("#filterLocations").append(MapApp.filtersView.el);MapApp.locationsView=new MapApp.Views.Locations({collection:MapApp.locationsCollection});$("#locationsView").append(MapApp.locationsView.render().el);MapApp.createLocationView=new MapApp.Views.CreateLocation({collection:MapApp.locationsCollection});new MapApp.Views.Map({collection:MapApp.locationsCollection});MapApp.activateMultiselect()})();